FROM composer/composer:1.1 as composer

ARG version=^1.0.5
ARG http_version=^1.0.5
RUN mkdir /ppm && cd /ppm && composer require php-pm/php-pm:${version} && composer require php-pm/httpkernel-adapter:${http_version}

FROM chialab/php:7.2

RUN docker-php-ext-install pcntl

# Fonts
RUN echo "deb http://deb.debian.org/debian stretch contrib non-free" >> /etc/apt/sources.list \
    && echo "deb http://deb.debian.org/debian stretch-updates contrib non-free" >> /etc/apt/sources.list \
    && echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections

RUN apt-get clean all
RUN apt-get update
RUN apt-get -y dist-upgrade

RUN apt-get install -y wget xfonts-base xfonts-75dpi fontconfig libfontconfig libxrender-dev libxext-dev ghostscript ttf-mscorefonts-installer

# Tahoma font
RUN wget https://alderson.eu.org/sites/fonts/IELPKTH.CAB
RUN cabextract -F 'tahoma*ttf' IELPKTH.CAB
RUN mv -f tahoma*ttf /usr/share/fonts/truetype/msttcorefonts/
RUN chmod 644 /usr/share/fonts/truetype/msttcorefonts/tahoma*
RUN fc-cache -v
RUN rm -f IELPKTH.CAB

# wkhtmltopdf
RUN wget https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5-1.stretch_amd64.deb
RUN dpkg -i wkhtmltox_0.12.5-1.stretch_amd64.deb

ADD etc/php.ini /etc/php7/php.ini

# Nginx
RUN apt-get install -y nginx
ADD etc/nginx_default.conf /etc/nginx/sites-enabled/default
ADD etc/nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

COPY --from=composer /ppm /ppm

WORKDIR /var/www

ADD run-nginx.sh /etc/app/run.sh
ENTRYPOINT ["/bin/bash", "/etc/app/run.sh"]
